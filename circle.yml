machine:
  environment:
    PATH: ~/.roswell/bin:~/nginx/sbin:$PATH

dependencies:
  pre:
    - curl -L https://raw.githubusercontent.com/snmsts/roswell/release/scripts/install-for-ci.sh | sh
    - case $CIRCLE_NODE_INDEX in
        0) ros config set default.lisp sbcl-bin ;;
        1) ros install ccl-bin;
           ros config set default.lisp ccl-bin ;;
      esac
    # nginx
    - curl -L http://nginx.org/download/nginx-1.8.0.tar.gz | tar xzf -
    - (cd nginx-1.8.0 && ./configure --prefix=$HOME/nginx && make && make install)
  override:
    - git clone https://github.com/fukamachi/proc-parse ~/lisp/proc-parse
    - git clone https://github.com/fukamachi/fast-http ~/lisp/fast-http
    - git clone https://github.com/fukamachi/quri ~/lisp/quri
    - git clone https://github.com/fukamachi/cl-cookie ~/lisp/cl-cookie
    - git clone https://github.com/fukamachi/cl-coveralls ~/lisp/cl-coveralls
    - git clone https://github.com/fukamachi/prove ~/lisp/prove
    - ros -l ~/lisp/prove/prove.asd install prove

test:
  pre:
    - nginx -c "/home/ubuntu/dexador/t/nginx.conf" -p "$HOME/nginx"
    - ros --version
    - ros run -- --version
  override:
    - if [ "$CIRCLE_NODE_INDEX" = 0 ]; then COVERALLS=true run-prove dexador-test.asd; else run-prove dexador-test.asd; fi: {parallel: true}
    - benchmark/bench
